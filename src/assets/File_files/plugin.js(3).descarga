"use strict";(function(){CKEDITOR.plugins.add("lineutils");CKEDITOR.LINEUTILS_BEFORE=1;CKEDITOR.LINEUTILS_AFTER=2;CKEDITOR.LINEUTILS_INSIDE=4;function a(o,p){CKEDITOR.tools.extend(this,{editor:o,editable:o.editable(),doc:o.document,win:o.window},p,true);this.frame=this.win.getFrame();this.inline=this.editable.isInline();this.target=this[this.inline?"editable":"doc"];}a.prototype={start:function(v){var s=this,r=this.editor,t=this.doc,q,o,u;var p=CKEDITOR.tools.eventsBuffer(50,function(){if(r.readOnly||r.mode!="wysiwyg"){return;}s.relations={};q=new CKEDITOR.dom.element(t.$.elementFromPoint(o,u));s.traverseSearch(q);if(!isNaN(o+u)){s.pixelSearch(q,o,u);}v&&v(s.relations,o,u);});this.listener=this.editable.attachListener(this.target,"mousemove",function(w){o=w.data.$.clientX;u=w.data.$.clientY;p.input();});this.editable.attachListener(this.inline?this.editable:this.frame,"mouseout",function(w){p.reset();});},stop:function(){if(this.listener){this.listener.removeListener();}},getRange:(function(){var o={};o[CKEDITOR.LINEUTILS_BEFORE]=CKEDITOR.POSITION_BEFORE_START;o[CKEDITOR.LINEUTILS_AFTER]=CKEDITOR.POSITION_AFTER_END;o[CKEDITOR.LINEUTILS_INSIDE]=CKEDITOR.POSITION_AFTER_START;return function(p){var q=this.editor.createRange();q.moveToPosition(this.relations[p.uid].element,o[p.type]);return q;};})(),store:(function(){function o(s,r,p){var q=s.getUniqueId();if(q in p){p[q].type|=r;}else{p[q]={element:s,type:r};}}return function(q,p){var r;if(d(p,CKEDITOR.LINEUTILS_AFTER)&&l(r=q.getNext())&&r.isVisible()){o(r,CKEDITOR.LINEUTILS_BEFORE,this.relations);p^=CKEDITOR.LINEUTILS_AFTER;}if(d(p,CKEDITOR.LINEUTILS_INSIDE)&&l(r=q.getFirst())&&r.isVisible()){o(r,CKEDITOR.LINEUTILS_BEFORE,this.relations);p^=CKEDITOR.LINEUTILS_INSIDE;}o(q,p,this.relations);};})(),traverseSearch:function(r){var o,q,p;do{p=r.$["data-cke-expando"];if(p&&p in this.relations){continue;}if(r.equals(this.editable)){return;}if(l(r)){for(o in this.lookups){if((q=this.lookups[o](r))){this.store(r,q);}}}}while(!b(r)&&(r=r.getParent()));},pixelSearch:(function(){var p=CKEDITOR.env.ie||CKEDITOR.env.webkit?function(q,r){return q.contains(r);}:function(q,r){return !!(q.compareDocumentPosition(r)&16);};function o(q,v,x,r,s){var w=x,t=0,z,u;while(s(w)){w+=r;if(++t==25){return;}z=this.doc.$.elementFromPoint(v,w);if(!z){continue;}else{if(z==q){t=0;continue;}else{if(!p(q,z)){continue;}}}t=0;if(l((z=new CKEDITOR.dom.element(z)))){return z;}}}return function(s,q,v){var r=this.win.getViewPaneSize().height,u=o.call(this,s.$,q,v,-1,function(w){return w>0;}),t=o.call(this,s.$,q,v,1,function(w){return w<r;});if(u){this.traverseSearch(u);while(!u.getParent().equals(s)){u=u.getParent();}}if(t){this.traverseSearch(t);while(!t.getParent().equals(s)){t=t.getParent();}}while(u||t){if(u){u=u.getNext(l);}if(!u||u.equals(t)){break;}this.traverseSearch(u);if(t){t=t.getPrevious(l);}if(!t||t.equals(u)){break;}this.traverseSearch(t);}};})(),greedySearch:function(){this.relations={};var s=this.editable.getElementsByTag("*"),p=0,r,q,o;while((r=s.getItem(p++))){if(r.equals(this.editable)){continue;}if(!r.hasAttribute("contenteditable")&&r.isReadOnly()){continue;}if(l(r)&&r.isVisible()){for(o in this.lookups){if((q=this.lookups[o](r))){this.store(r,q);}}}}return this.relations;}};function m(o,p){CKEDITOR.tools.extend(this,p,{editor:o},true);}m.prototype={locate:(function(){var o,p;function q(r,t){var s=r.element[t===CKEDITOR.LINEUTILS_BEFORE?"getPrevious":"getNext"]();if(s&&l(s)){r.siblingRect=s.getClientRect();if(t==CKEDITOR.LINEUTILS_BEFORE){return(r.siblingRect.bottom+r.elementRect.top)/2;}else{return(r.elementRect.bottom+r.siblingRect.top)/2;}}else{if(t==CKEDITOR.LINEUTILS_BEFORE){return r.elementRect.top;}else{return r.elementRect.bottom;}}}return function(r){this.locations={};for(p in r){o=r[p];o.elementRect=o.element.getClientRect();if(d(o.type,CKEDITOR.LINEUTILS_BEFORE)){this.store(p,CKEDITOR.LINEUTILS_BEFORE,q(o,CKEDITOR.LINEUTILS_BEFORE));}if(d(o.type,CKEDITOR.LINEUTILS_AFTER)){this.store(p,CKEDITOR.LINEUTILS_AFTER,q(o,CKEDITOR.LINEUTILS_AFTER));}if(d(o.type,CKEDITOR.LINEUTILS_INSIDE)){this.store(p,CKEDITOR.LINEUTILS_INSIDE,(o.elementRect.top+o.elementRect.bottom)/2);}}return this.locations;};})(),sort:(function(){var o,p,t,r,s,q;function u(v){return Math.abs(v-o[r][s]);}return function(w,v){o=this.locations;p=[];for(r in o){for(s in o[r]){t=u(w);if(!p.length){p.push({uid:+r,type:s,dist:t});}else{for(q=0;q<p.length;q++){if(t<p[q].dist){p.splice(q,0,{uid:+r,type:s,dist:t});break;}}if(q==p.length){p.push({uid:+r,type:s,dist:t});}}}}if(typeof v!="undefined"){return p.slice(0,v);}else{return p;}};})(),store:function(o,p,q){if(!this.locations[o]){this.locations[o]={};}this.locations[o][p]=q;}};var j={display:"block",width:"0px",height:"0px","border-color":"transparent","border-style":"solid",position:"absolute",top:"-6px"},e={height:"0px","border-top":"1px dashed red",position:"absolute","z-index":9999},f='<div data-cke-lineutils-line="1" class="cke_reset_all" style="{lineStyle}"><span style="{tipLeftStyle}">&nbsp;</span><span style="{tipRightStyle}">&nbsp;</span></div>';function k(r,t){var p=r.editable();CKEDITOR.tools.extend(this,{editor:r,editable:p,doc:r.document,win:r.window,container:CKEDITOR.document.getBody(),winTop:CKEDITOR.document.getWindow()},t,true);this.hidden={};this.visible={};this.inline=p.isInline();if(!this.inline){this.frame=this.win.getFrame();}this.queryViewport();var s=CKEDITOR.tools.bind(this.queryViewport,this),o=CKEDITOR.tools.bind(this.hideVisible,this),q=CKEDITOR.tools.bind(this.removeAll,this);p.attachListener(this.winTop,"resize",s);p.attachListener(this.winTop,"scroll",s);p.attachListener(this.winTop,"resize",o);p.attachListener(this.win,"scroll",o);p.attachListener(this.inline?p:this.frame,"mouseout",function(v){var u=v.data.$.clientX,w=v.data.$.clientY;this.queryViewport();if(u<=this.rect.left||u>=this.rect.right||w<=this.rect.top||w>=this.rect.bottom){this.hideVisible();}if(u<=0||u>=this.winTopPane.width||w<=0||w>=this.winTopPane.height){this.hideVisible();}},this);p.attachListener(r,"resize",s);p.attachListener(r,"mode",q);r.on("destroy",q);this.lineTpl=new CKEDITOR.template(f).output({lineStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},e,this.lineStyle,true)),tipLeftStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},j,{left:"0px","border-left-color":"red","border-width":"6px 0 6px 6px"},this.tipCss,this.tipLeftStyle,true)),tipRightStyle:CKEDITOR.tools.writeCssText(CKEDITOR.tools.extend({},j,{right:"0px","border-right-color":"red","border-width":"6px 6px 6px 0"},this.tipCss,this.tipRightStyle,true))});}k.prototype={removeAll:function(){var o;for(o in this.hidden){this.hidden[o].remove();delete this.hidden[o];}for(o in this.visible){this.visible[o].remove();delete this.visible[o];}},hideLine:function(o){var p=o.getUniqueId();o.hide();this.hidden[p]=o;delete this.visible[p];},showLine:function(o){var p=o.getUniqueId();o.show();this.visible[p]=o;delete this.hidden[p];},hideVisible:function(){for(var o in this.visible){this.hideLine(this.visible[o]);}},placeLine:function(q,s){var r,p,o;if(!(r=this.getStyle(q.uid,q.type))){return;}for(o in this.visible){if(this.visible[o].getCustomData("hash")!==this.hash){p=this.visible[o];break;}}if(!p){for(o in this.hidden){if(this.hidden[o].getCustomData("hash")!==this.hash){this.showLine((p=this.hidden[o]));break;}}}if(!p){this.showLine((p=this.addLine()));}p.setCustomData("hash",this.hash);this.visible[p.getUniqueId()]=p;p.setStyles(r);s&&s(p);},getStyle:function(p,s){var o=this.relations[p],u=this.locations[p][s],t={},r;if(o.siblingRect){t.width=Math.max(o.siblingRect.width,o.elementRect.width);}else{t.width=o.elementRect.width;}if(this.inline){t.top=u+this.winTopScroll.y;}else{t.top=this.rect.top+this.winTopScroll.y+u;}if(t.top-this.winTopScroll.y<this.rect.top||t.top-this.winTopScroll.y>this.rect.bottom){return false;}if(this.inline){t.left=o.elementRect.left;}else{if(o.elementRect.left>0){t.left=this.rect.left+o.elementRect.left;}else{t.width+=o.elementRect.left;t.left=this.rect.left;}if((r=t.left+t.width-(this.rect.left+this.winPane.width))>0){t.width-=r;}}t.left+=this.winTopScroll.x;for(var q in t){t[q]=CKEDITOR.tools.cssLength(t[q]);}return t;},addLine:function(){var o=CKEDITOR.dom.element.createFromHtml(this.lineTpl);o.appendTo(this.container);return o;},prepare:function(p,o){this.relations=p;this.locations=o;this.hash=Math.random();},cleanup:function(){var p;for(var o in this.visible){p=this.visible[o];if(p.getCustomData("hash")!==this.hash){this.hideLine(p);}}},queryViewport:function(){this.winPane=this.win.getViewPaneSize();this.winTopScroll=this.winTop.getScrollPosition();this.winTopPane=this.winTop.getViewPaneSize();if(this.inline){this.rect=this.editable.getClientRect();}else{this.rect=this.frame.getClientRect();}}};function d(p,o){return p&o;}var i={left:1,right:1,center:1},c={absolute:1,fixed:1};function g(o){return o&&o.type==CKEDITOR.NODE_ELEMENT;}function h(o){return !!(i[o.getComputedStyle("float")]||i[o.getAttribute("align")]);}function n(o){return !!c[o.getComputedStyle("position")];}function b(o){return g(o)&&o.getAttribute("contenteditable")=="true";}function l(o){return g(o)&&!h(o)&&!n(o);}CKEDITOR.plugins.lineutils={finder:a,locator:m,liner:k};})();